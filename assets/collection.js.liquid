(function($) {

  $(document).ready(function() {
    collection.init();
  });

  if ($(".engoj-collection-sidebar")) {
    History.Adapter.bind(window, 'statechange', function() {
      var State = History.getState();
      if (!collection.fillterClick) {
        collection.filterParams();
        var newurl = collection.filterCreateUrl();
        collection.filterGetContent(newurl);
        collection.resetFilter();
      }
      collection.fillterClick = false;
    });
  }

  var collection = {
    init: function() {
      /* Collection Filter */
      this.initCollectionFilter();
      /* Collection Sorting */
      this.initCollectionSorting();
    },

    /* --------------------------------------------------------- */
    /* Categories Filter */
    filterCategories: function() {
      // Implement if needed
    },

    /* --------------------------------------------------------- */
    /* Tag Filtering */
    fillterTagEvents: function() {
      $("body").delegate('.filter-tag a:not(".clear"), .filter-tag label', 'click', function(e) {
        $(this).toggleClass('active');
        var currentTags = [];
        if (Shopify.queryParams.constraint) {
          currentTags = Shopify.queryParams.constraint.split('+');
        }
        if (!window.filter_mul_choice && !$(this).prev().is(":checked")) {
          var otherTag = $(this).parents('.filter-tag').find("input:checked");
          if (otherTag.length > 0) {
            var tagName = otherTag.val();
            if (tagName) {
              var tagPos = currentTags.indexOf(tagName);
              if (tagPos >= 0) {
                currentTags.splice(tagPos, 1);
              }
            }
          }
        }
        var tagName = $(this).prev().val();
        if (tagName) {
          var tagPos = currentTags.indexOf(tagName);
          if (tagPos >= 0) {
            currentTags.splice(tagPos, 1);
          } else {
            currentTags.push(tagName);
          }
        }
        if (currentTags.length) {
          Shopify.queryParams.constraint = currentTags.join('+');
        } else {
          delete Shopify.queryParams.constraint;
        }
        collection.filterAjaxClick();
        e.preventDefault();
      });
    },

    /* --------------------------------------------------------- */
    /* Clear All Filters */
    filterMapClearAll: function() {
      $("body").delegate('.refined-widgets a.clear-all', 'click', function(e) {
        delete Shopify.queryParams.constraint;
        delete Shopify.queryParams.q;
        collection.filterAjaxClick();
        e.preventDefault();
        $('.filter-tag a:not(".clear"), .filter-tag label').removeClass('active');
      });

      $("body").delegate('.filter-block .clear', 'click', function(e) {
        var currentTags = [];
        var filterTag = $(this).parent().parent();
        if (Shopify.queryParams.constraint) {
          currentTags = Shopify.queryParams.constraint.split('+');
        }
        filterTag.find("input:checked").each(function() {
          var selectedTag = $(this);
          var tagName = selectedTag.val();
          if (tagName) {
            var tagPos = currentTags.indexOf(tagName);
            if (tagPos >= 0) {
              currentTags.splice(tagPos, 1);
            }
          }
        });
        filterTag.find("a").each(function() {
          $(this).removeClass("active");
        });
        if (currentTags.length) {
          Shopify.queryParams.constraint = currentTags.join('+');
        } else {
          delete Shopify.queryParams.constraint;
        }
        collection.filterAjaxClick();
        e.preventDefault();
      });
    },

    /* --------------------------------------------------------- */
    /* Initialize Collection Filter */
    initCollectionFilter: function() {
      if ($(".engoj-collection-sidebar").length > 0) {
        collection.filterParams();
        collection.filterMapEvents();
        collection.filterMapClear();
        collection.filterMapClearAll();
        collection.initPriceFilter(); // Initialize price filter
      }
    },

    /* --------------------------------------------------------- */
    /* Price Filtering */
    initPriceFilter: function() {
      $(".list-price input[type='checkbox']").change(function() {
        var minMax = $(this).val().split('-');
        var minPrice = parseFloat(minMax[0]);
        var maxPrice = parseFloat(minMax[1]);

        // Filter products based on price range
        var products = document.querySelectorAll('.product');
        products.forEach(function(product) {
          var productPrice = parseFloat(product.dataset.price);
          if (productPrice >= minPrice && productPrice <= maxPrice) {
            product.style.display = 'block';
          } else {
            product.style.display = 'none';
          }
        });

        // Update URL and fetch filtered content
        collection.filterAjaxClick();
      });
    },

    /* --------------------------------------------------------- */
    /* Collection Sorting */
    initCollectionSorting: function() {
      $(".collection-sorting a").click(function(e) {
        e.preventDefault();
        if (!$(this).parent().hasClass("active")) {
          Shopify.queryParams.sort_by = $(this).attr("href");
          collection.filterAjaxClick();
          $(".collection-sorting li.active").removeClass("active");
          $(this).parent().addClass("active");
        }
        var selected = $(this).text();
        $(this).closest('.dropdown').find('.dropdown-label').text(selected);
        $(this).closest('.dropdown-content').removeClass('active');
      });
    },

    /* --------------------------------------------------------- */
    /* Create Filtered URL */
    filterCreateUrl: function(baseLink) {
      var newQuery = $.param(Shopify.queryParams).replace(/%2B/g, '+');
      if (baseLink) {
        if (newQuery != "")
          return baseLink + "?" + newQuery;
        else
          return baseLink;
      }
      return location.pathname + "?" + newQuery;
    },

    /* --------------------------------------------------------- */
    /* AJAX Filtering */
    filterAjaxClick: function(baseLink) {
      delete Shopify.queryParams.page;
      var newurl = collection.filterCreateUrl(baseLink);
      collection.fillterClick = true;
      History.pushState({
        param: Shopify.queryParams
      }, newurl, newurl);
      collection.filterGetContent(newurl);
    },

    /* --------------------------------------------------------- */
    /* Fetch Filtered Content */
    filterGetContent: function(newurl) {
      $.ajax({
        type: 'get',
        url: newurl,
        beforeSend: function() {
          showPopup('.loading');
        },
        success: function(data) {
          collection.filterMapData(data);
          collection.filterMapClear();
          hidePopup('.loading');
          hidePopup('.filter-to-left , .js-bg');
        },
        error: function(xhr, text) {
          hidePopup('.loading');
          hidePopup('.filter-to-left, .js-bg');
          $('.ajax-error-message').text($.parseJSON(xhr.responseText).description);
          showPopup('.ajax-error-modal');
        }
      });
    },

    /* --------------------------------------------------------- */
    /* Reset All Filters */
    resetFilter: function() {
      $(".filter-custom .active, .filter-links .active").removeClass("active");
      $(".filter-tag input:checked").attr("checked", false);
      var cat = location.pathname.match(/\/collections\/(.*)(\?)?/);
      if (cat && cat[1]) {
        $(".filter-links a[href='" + cat[0] + "']").addClass("active");
      }
    },

    /* --------------------------------------------------------- */
    /* Map Filtered Data */
    filterMapData: function(data) {
      var currentList = $(".grid-uniform");
      var productList = $(data).find(".grid-uniform");
      currentList.replaceWith(productList);

      if ($(".pagination").length > 0) {
        $(".pagination").replaceWith($(data).find(".pagination"));
      }

      $('.filter-blocks').replaceWith($(data).find(".filter-blocks"));
      collection.filterMapClearAll();
      quickView();
      var ajaxCartConfig = {
        cartContainer: '.enj-minicart-ajax',
        addToCartSelector: '.enj-add-to-cart-btn',
        cartCountSelector: '.enj-cartcount',
        cartCostSelector: '.enj-cartcost',
        moneyFormat: {{ shop.money_format | json }}
      };
      $(function($) {
        ajaxCart.init(ajaxCartConfig);
      });

      function loadmore() {
        $('.loadmore').children('a').on('click', function(e) {
          $('.loadmore').addClass('d-none');
          $('.loading.tshopify-popup').addClass('active');
          var link = $('.loadmore').children('a').attr('href');
          if (link != '#') {
            $('.load-data').load(link + ' .product-grid-view .row')

            setTimeout(function() {
              $('.load-data .js_loadmore').each(function() {
                $(this).appendTo('.product-grid-view .row')
              })
              $('.loadmore').eq(0).remove();
              loadmore();
              quickView();
              var ajaxCartConfig = {
                cartContainer: '.enj-minicart-ajax',
                addToCartSelector: '.enj-add-to-cart-btn',
                cartCountSelector: '.enj-cartcount',
                cartCostSelector: '.enj-cartcost',
                moneyFormat: {{ shop.money_format | json }}
              };
              $(function($) {
                ajaxCart.init(ajaxCartConfig);
              });

              $('.loading.tshopify-popup').removeClass('active');
            }, 2000)
          } else {
            $('.loadmore').remove();
          }
          e.preventDefault();
        })
      }
      loadmore();

      $('.engoj_select_color a').each(function() {
        $(this).on("click", function() {
          var engoImage = $(this).data('engojvariant-img');
          $(this).parents('.engoj_grid_parent').find('.engoj_find_img img').attr({
            src: engoImage
          });
          return false;
        });
      });

    },

    /* --------------------------------------------------------- */
    /* Fetch Initial Filter Parameters */
    filterParams: function() {
      Shopify.queryParams = {};
      if (location.search.length) {
        for (var aKeyValue, i = 0, aCouples = location.search.substr(1).split('&'); i < aCouples.length; i++) {
          aKeyValue = aCouples[i].split('=');
          if (aKeyValue.length > 1) {
            Shopify.queryParams[decodeURIComponent(aKeyValue[0])] = decodeURIComponent(aKeyValue[1]);
          }
        }
      }
    },

    /* --------------------------------------------------------- */
    /* Event Binding for Tag Filtering */
    filterMapEvents: function() {
      collection.fillterTagEvents();
    }
  };

})(jQuery);
